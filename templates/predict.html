{% extends "base.html" %}

{% block title %}Predict - Stock Price Predictor{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- Search Section -->
    <div class="row justify-content-center mb-5">
        <div class="col-md-8">
            <div class="card shadow-lg">
                <div class="card-body p-4">
                    <h4 class="card-title mb-4">
                        <i class="fas fa-search"></i> Stock Price Prediction
                    </h4>
                    <div class="input-group input-group-lg">
                        <input type="text" 
                               class="form-control" 
                               id="tickerInput" 
                               placeholder="Enter stock ticker (e.g., AAPL, GOOGL, TSLA)"
                               value="{{ ticker }}">
                        <button class="btn btn-primary" type="button" id="predictBtn">
                            <i class="fas fa-chart-line"></i> Predict
                        </button>
                        <button class="btn btn-outline-secondary" type="button" id="addWatchlistBtn" title="Add to Watchlist">
                            <i class="fas fa-star"></i>
                        </button>
                    </div>
                    <div class="mt-3 d-flex align-items-center">
                        <small class="text-muted">
                            <i class="fas fa-sync-alt me-1"></i> Auto-refreshing every 30 seconds
                        </small>
                        <span id="lastUpdate" class="ms-auto text-muted small"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="text-center" style="display: none;">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Analyzing stock data and generating predictions...</p>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" style="display: none;">
        <!-- Stock Info Card -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h3 class="mb-1" id="stockName">-</h3>
                        <p class="text-muted mb-2" id="stockSymbol">-</p>
                        <span class="badge bg-primary me-2" id="stockSector">-</span>
                        <span class="badge bg-secondary" id="stockIndustry">-</span>
                    </div>
                    <div class="col-md-4 text-end">
                        <h2 class="mb-0" id="currentPrice">$0.00</h2>
                        <p class="mb-0" id="priceChange">
                            <span class="text-muted">Change: </span>
                            <span id="changeValue">$0.00 (0.00%)</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metrics Cards -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label">RMSE</div>
                    <div class="metric-value" id="rmseValue">-</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label">MAE</div>
                    <div class="metric-value" id="maeValue">-</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label">MAPE</div>
                    <div class="metric-value" id="mapeValue">-</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label">R² Score</div>
                    <div class="metric-value" id="r2Value">-</div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row g-4">
            <!-- Historical Price Chart -->
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-chart-area"></i> Historical Price (90 Days)
                        </h5>
                        <canvas id="historicalChart" height="80"></canvas>
                    </div>
                </div>
            </div>

            <!-- Future Predictions Chart -->
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-crystal-ball"></i> Future Predictions (30 Days)
                        </h5>
                        <canvas id="futureChart" height="80"></canvas>
                    </div>
                </div>
            </div>

            <!-- Volume Chart -->
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-chart-bar"></i> Trading Volume
                        </h5>
                        <canvas id="volumeChart" height="60"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Alert -->
    <div id="errorAlert" class="alert alert-danger" role="alert" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i> <span id="errorMessage"></span>
    </div>
</div>

<style>
@keyframes pulseFade {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.8; transform: scale(1.05); }
}

#currentPrice {
    transition: all 0.3s ease;
}

.badge {
    padding: 8px 16px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 20px;
}
</style>

<script>
let historicalChart, futureChart, volumeChart;
let autoRefreshInterval;
let currentTicker = '';

// Auto-predict if ticker is provided in URL
document.addEventListener('DOMContentLoaded', function() {
    const ticker = document.getElementById('tickerInput').value;
    if (ticker) {
        predict();
    }
    
    // Start auto-refresh timer (every 30 seconds)
    startAutoRefresh();
    
    // Update last update time
    updateLastUpdateTime();
});

function startAutoRefresh() {
    // Clear any existing interval
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    
    // Refresh every 30 seconds if we have a ticker
    autoRefreshInterval = setInterval(() => {
        if (currentTicker && document.visibilityState === 'visible') {
            console.log('[AUTO-REFRESH] Updating prices...');
            refreshPrices();
        }
    }, 30000); // 30 seconds
}

async function refreshPrices() {
    if (!currentTicker) return;
    
    try {
        const response = await fetch('/api/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ticker: currentTicker })
        });
        
        const data = await response.json();
        
        if (data.success && data.info) {
            // Update prices without reloading charts
            updatePriceDisplay(data.info);
            updateLastUpdateTime();
        }
    } catch (error) {
        console.error('[AUTO-REFRESH] Error:', error);
    }
}

function updatePriceDisplay(info) {
    document.getElementById('currentPrice').textContent = `$${info.current_price.toFixed(2)}`;
    
    const change = info.current_price - info.previous_close;
    const changePct = (change / info.previous_close) * 100;
    const changeClass = change >= 0 ? 'text-success' : 'text-danger';
    const changeIcon = change >= 0 ? '▲' : '▼';
    
    document.getElementById('changeValue').innerHTML = `
        <span class="${changeClass}">
            ${changeIcon} $${Math.abs(change).toFixed(2)} (${Math.abs(changePct).toFixed(2)}%)
        </span>
    `;
    
    // Add pulse animation
    const priceElement = document.getElementById('currentPrice');
    priceElement.style.animation = 'none';
    setTimeout(() => {
        priceElement.style.animation = 'pulseFade 1s ease';
    }, 10);
}

function updateLastUpdateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit' 
    });
    document.getElementById('lastUpdate').textContent = `Last updated: ${timeString}`;
}

document.getElementById('predictBtn').addEventListener('click', predict);
document.getElementById('tickerInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        predict();
    }
});

document.getElementById('addWatchlistBtn').addEventListener('click', function() {
    const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
    if (!ticker) {
        showAlert('Please enter a ticker first', 'warning');
        return;
    }
    addToWatchlist(ticker);
});

async function predict() {
    const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
    
    if (!ticker) {
        showAlert('Please enter a stock ticker', 'warning');
        return;
    }
    
    currentTicker = ticker;
    
    // Show loading
    document.getElementById('loadingSpinner').style.display = 'block';
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('errorAlert').style.display = 'none';
    
    try {
        const response = await fetch('/api/predict', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ticker: ticker })
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayResults(data);
            updateLastUpdateTime();
        } else {
            showError(data.error || 'Failed to generate predictions');
        }
    } catch (error) {
        showError('Error connecting to server: ' + error.message);
    } finally {
        document.getElementById('loadingSpinner').style.display = 'none';
    }
}

function displayResults(data) {
    // Show results section
    document.getElementById('resultsSection').style.display = 'block';
    
    // Display stock info
    document.getElementById('stockName').textContent = data.info.name;
    document.getElementById('stockSymbol').textContent = data.ticker;
    document.getElementById('stockSector').textContent = data.info.sector;
    document.getElementById('stockIndustry').textContent = data.info.industry;
    updatePriceDisplay(data.info);
    
    // Display metrics
    document.getElementById('rmseValue').textContent = data.metrics.rmse.toFixed(2);
    document.getElementById('maeValue').textContent = data.metrics.mae.toFixed(2);
    document.getElementById('mapeValue').textContent = data.metrics.mape.toFixed(2) + '%';
    document.getElementById('r2Value').textContent = data.metrics.r2_score.toFixed(4);
    
    // Create interactive charts
    createHistoricalChart(data.historical);
    createFutureChart(data.future);
    createVolumeChart(data.historical);
}

function createHistoricalChart(historical) {
    const ctx = document.getElementById('historicalChart');
    
    if (historicalChart) {
        historicalChart.destroy();
    }
    
    historicalChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: historical.dates.slice(-90),
            datasets: [{
                label: 'Close Price',
                data: historical.close.slice(-90),
                borderColor: '#8B5CF6',
                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: '#8B5CF6',
                pointHoverBorderColor: '#fff',
                pointHoverBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        color: '#E2E8F0',
                        font: {
                            size: 14
                        }
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(26, 26, 46, 0.95)',
                    titleColor: '#E2E8F0',
                    bodyColor: '#94A3B8',
                    borderColor: '#8B5CF6',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: true,
                    callbacks: {
                        label: function(context) {
                            return 'Price: $' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(45, 45, 68, 0.5)'
                    },
                    ticks: {
                        color: '#94A3B8',
                        maxTicksLimit: 8
                    }
                },
                y: {
                    beginAtZero: false,
                    grid: {
                        color: 'rgba(45, 45, 68, 0.5)'
                    },
                    ticks: {
                        color: '#94A3B8',
                        callback: function(value) {
                            return '$' + value.toFixed(2);
                        }
                    }
                }
            }
        }
    });
}

function createFutureChart(future) {
    const ctx = document.getElementById('futureChart');
    
    if (futureChart) {
        futureChart.destroy();
    }
    
    futureChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: future.dates,
            datasets: [{
                label: 'Predicted Price',
                data: future.prices,
                borderColor: '#EC4899',
                backgroundColor: 'rgba(236, 72, 153, 0.1)',
                borderDash: [5, 5],
                tension: 0.4,
                fill: true,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: '#EC4899',
                pointHoverBorderColor: '#fff',
                pointHoverBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        color: '#E2E8F0',
                        font: {
                            size: 14
                        }
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(26, 26, 46, 0.95)',
                    titleColor: '#E2E8F0',
                    bodyColor: '#94A3B8',
                    borderColor: '#EC4899',
                    borderWidth: 1,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            return 'Predicted: $' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(45, 45, 68, 0.5)'
                    },
                    ticks: {
                        color: '#94A3B8',
                        maxTicksLimit: 8
                    }
                },
                y: {
                    beginAtZero: false,
                    grid: {
                        color: 'rgba(45, 45, 68, 0.5)'
                    },
                    ticks: {
                        color: '#94A3B8',
                        callback: function(value) {
                            return '$' + value.toFixed(2);
                        }
                    }
                }
            }
        }
    });
}

function createVolumeChart(historical) {
    const ctx = document.getElementById('volumeChart');
    
    if (volumeChart) {
        volumeChart.destroy();
    }
    
    volumeChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: historical.dates.slice(-90),
            datasets: [{
                label: 'Volume',
                data: historical.volume.slice(-90),
                backgroundColor: 'rgba(139, 92, 246, 0.5)',
                borderColor: '#8B5CF6',
                borderWidth: 1,
                hoverBackgroundColor: 'rgba(139, 92, 246, 0.8)'
            }]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(26, 26, 46, 0.95)',
                    titleColor: '#E2E8F0',
                    bodyColor: '#94A3B8',
                    borderColor: '#8B5CF6',
                    borderWidth: 1,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            return 'Volume: ' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: '#94A3B8',
                        maxTicksLimit: 8
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(45, 45, 68, 0.5)'
                    },
                    ticks: {
                        color: '#94A3B8',
                        callback: function(value) {
                            if (value >= 1e9) return (value / 1e9).toFixed(1) + 'B';
                            if (value >= 1e6) return (value / 1e6).toFixed(1) + 'M';
                            if (value >= 1e3) return (value / 1e3).toFixed(1) + 'K';
                            return value;
                        }
                    }
                }
            }
        }
    });
}

async function addToWatchlist(ticker) {
    try {
        const response = await fetch('/api/watchlist/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ticker: ticker })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('Added to watchlist!', 'success');
        } else {
            showAlert(data.error, 'warning');
        }
    } catch (error) {
        showAlert('Error adding to watchlist', 'danger');
    }
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorAlert').style.display = 'block';
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.style.minWidth = '300px';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => alertDiv.remove(), 3000);
}

// Stop auto-refresh when leaving page
window.addEventListener('beforeunload', function() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});
</script>
{% endblock %}